{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://workshop.example.com/contracts/exercise-4-virtual-analyst.json",
    "title": "Exercise 4: Virtual Analyst Multi-Source Orchestration Contract",
    "description": "Integrative group challenge: AI agent orchestrating multiple MCP servers for business intelligence",
    "version": "1.0.0",
    "extends": "mcp-server-base.json",
    "scenario": {
        "title": "Virtual Business Analyst",
        "description": "Build an AI-powered analyst that answers business questions by querying multiple data sources through MCP servers",
        "userStory": "As a business user, I want to ask natural language questions about customers, sales, and inventory, so that the system retrieves and synthesizes data from multiple sources automatically.",
        "exampleQuestions": [
            "¿Cuántos clientes tenemos en España con pedidos activos?",
            "¿Cuál es el producto más vendido en el último mes?",
            "¿Qué clientes tienen carritos abandonados con valor superior a 100€?",
            "Resume las tendencias de ventas por región en el último trimestre"
        ]
    },
    "architecture": {
        "components": [
            {
                "name": "OrchestratorService",
                "description": "Coordinates MCP server communication and result synthesis",
                "responsibilities": [
                    "Parse natural language query intent",
                    "Route to appropriate MCP servers",
                    "Aggregate responses",
                    "Format final answer"
                ]
            },
            {
                "name": "SqlMcpServer",
                "description": "Exposes Azure SQL data (customers, orders, products)",
                "uri": "http://localhost:5001/mcp",
                "capabilities": [
                    "resources",
                    "tools"
                ]
            },
            {
                "name": "CosmosMcpServer",
                "description": "Exposes Cosmos DB data (analytics, user sessions)",
                "uri": "http://localhost:5002/mcp",
                "capabilities": [
                    "resources",
                    "tools"
                ]
            },
            {
                "name": "RestApiMcpServer",
                "description": "Wraps external REST API (inventory, shipping)",
                "uri": "http://localhost:5003/mcp",
                "capabilities": [
                    "tools"
                ]
            }
        ],
        "dataFlow": {
            "description": "User question → Orchestrator → [SQL, Cosmos, REST] → Synthesis → Response",
            "diagram": "See data-model.md for Mermaid diagram"
        }
    },
    "mcpServers": [
        {
            "name": "sql-mcp-server",
            "endpoint": "http://localhost:5001/mcp",
            "resources": [
                {
                    "uri": "sql://workshop/customers",
                    "description": "Customer master data"
                },
                {
                    "uri": "sql://workshop/orders",
                    "description": "Order transactions"
                },
                {
                    "uri": "sql://workshop/products",
                    "description": "Product catalog"
                }
            ],
            "tools": [
                {
                    "name": "query_customers_by_country",
                    "description": "Get customers filtered by country",
                    "inputSchema": {
                        "type": "object",
                        "properties": {
                            "country": {
                                "type": "string"
                            },
                            "hasActiveOrders": {
                                "type": "boolean"
                            }
                        }
                    }
                },
                {
                    "name": "get_sales_summary",
                    "description": "Aggregate sales data by period",
                    "inputSchema": {
                        "type": "object",
                        "properties": {
                            "startDate": {
                                "type": "string",
                                "format": "date"
                            },
                            "endDate": {
                                "type": "string",
                                "format": "date"
                            },
                            "groupBy": {
                                "type": "string",
                                "enum": [
                                    "product",
                                    "region",
                                    "customer"
                                ]
                            }
                        }
                    }
                }
            ]
        },
        {
            "name": "cosmos-mcp-server",
            "endpoint": "http://localhost:5002/mcp",
            "resources": [
                {
                    "uri": "cosmos://analytics/user-sessions",
                    "description": "User browsing sessions"
                },
                {
                    "uri": "cosmos://analytics/cart-events",
                    "description": "Shopping cart events"
                }
            ],
            "tools": [
                {
                    "name": "get_abandoned_carts",
                    "description": "Find abandoned carts above threshold",
                    "inputSchema": {
                        "type": "object",
                        "properties": {
                            "minValue": {
                                "type": "number"
                            },
                            "daysAgo": {
                                "type": "integer"
                            }
                        }
                    }
                },
                {
                    "name": "analyze_user_behavior",
                    "description": "Get user engagement metrics",
                    "inputSchema": {
                        "type": "object",
                        "properties": {
                            "userId": {
                                "type": "string"
                            },
                            "metricType": {
                                "type": "string",
                                "enum": [
                                    "sessions",
                                    "pageviews",
                                    "conversions"
                                ]
                            }
                        }
                    }
                }
            ]
        },
        {
            "name": "rest-api-mcp-server",
            "endpoint": "http://localhost:5003/mcp",
            "tools": [
                {
                    "name": "check_inventory",
                    "description": "Check product inventory across warehouses",
                    "inputSchema": {
                        "type": "object",
                        "properties": {
                            "productId": {
                                "type": "integer"
                            },
                            "warehouseIds": {
                                "type": "array",
                                "items": {
                                    "type": "string"
                                }
                            }
                        }
                    }
                },
                {
                    "name": "get_shipping_status",
                    "description": "Get order shipping information",
                    "inputSchema": {
                        "type": "object",
                        "properties": {
                            "orderId": {
                                "type": "integer"
                            }
                        }
                    }
                }
            ]
        }
    ],
    "orchestratorContract": {
        "api": {
            "endpoint": "/api/analyst/query",
            "method": "POST",
            "requestSchema": {
                "type": "object",
                "required": [
                    "question"
                ],
                "properties": {
                    "question": {
                        "type": "string",
                        "description": "Natural language business question"
                    },
                    "context": {
                        "type": "object",
                        "description": "Optional contextual parameters"
                    }
                }
            },
            "responseSchema": {
                "type": "object",
                "required": [
                    "answer",
                    "sources"
                ],
                "properties": {
                    "answer": {
                        "type": "string",
                        "description": "Synthesized answer to the question"
                    },
                    "sources": {
                        "type": "array",
                        "description": "MCP servers queried",
                        "items": {
                            "type": "object",
                            "properties": {
                                "server": {
                                    "type": "string"
                                },
                                "method": {
                                    "type": "string"
                                },
                                "data": {
                                    "type": "object"
                                }
                            }
                        }
                    },
                    "confidence": {
                        "type": "number",
                        "minimum": 0,
                        "maximum": 1,
                        "description": "Answer confidence score"
                    },
                    "processingTime": {
                        "type": "integer",
                        "description": "Total processing time in milliseconds"
                    }
                }
            }
        },
        "exampleRequest": {
            "question": "¿Cuántos clientes tenemos en España con pedidos activos?"
        },
        "exampleResponse": {
            "answer": "Hay 42 clientes en España con pedidos activos. Detalles: 28 con pedidos en proceso, 14 con pedidos pendientes de envío.",
            "sources": [
                {
                    "server": "sql-mcp-server",
                    "method": "query_customers_by_country",
                    "data": {
                        "country": "España",
                        "hasActiveOrders": true
                    }
                },
                {
                    "server": "sql-mcp-server",
                    "method": "get_sales_summary",
                    "data": {
                        "groupBy": "customer"
                    }
                }
            ],
            "confidence": 0.95,
            "processingTime": 450
        }
    },
    "successCriteria": [
        "Orchestrator successfully initializes connections to all 3 MCP servers",
        "Natural language questions are parsed into MCP tool calls",
        "System queries at least 2 different MCP servers per complex question",
        "Responses aggregate data from multiple sources coherently",
        "Processing time for multi-source queries < 2 seconds p95",
        "Orchestrator handles MCP server failures gracefully (fallback to available sources)",
        "Caching strategy reduces redundant MCP calls for repeated queries",
        "Logging traces entire query path across all MCP servers"
    ],
    "verificationScript": {
        "language": "powershell",
        "commands": [
            "# Start all MCP servers",
            "$sqlServer = Start-Process -FilePath 'dotnet' -ArgumentList 'run --project src/McpWorkshop.Servers/SqlMcpServer' -PassThru",
            "$cosmosServer = Start-Process -FilePath 'dotnet' -ArgumentList 'run --project src/McpWorkshop.Servers/CosmosMcpServer' -PassThru",
            "$restServer = Start-Process -FilePath 'dotnet' -ArgumentList 'run --project src/McpWorkshop.Servers/RestApiMcpServer' -PassThru",
            "Start-Sleep -Seconds 5",
            "",
            "# Start orchestrator",
            "$orchestrator = Start-Process -FilePath 'dotnet' -ArgumentList 'run --project src/McpWorkshop.Servers/VirtualAnalyst' -PassThru",
            "Start-Sleep -Seconds 3",
            "",
            "# Test multi-source query",
            "$queryBody = @{",
            "  question = '¿Cuántos clientes tenemos en España con pedidos activos?'",
            "} | ConvertTo-Json",
            "$response = Invoke-RestMethod -Uri 'http://localhost:5000/api/analyst/query' -Method POST -Body $queryBody -ContentType 'application/json'",
            "",
            "# Verify response",
            "if ($response.sources.Count -ge 2) { Write-Host '✓ Multi-source orchestration passed' }",
            "if ($response.processingTime -lt 2000) { Write-Host '✓ Performance target met' }",
            "if ($response.answer) { Write-Host '✓ Answer synthesis passed' }",
            "",
            "# Test error handling (stop one server)",
            "Stop-Process -Id $cosmosServer.Id",
            "$fallbackResponse = Invoke-RestMethod -Uri 'http://localhost:5000/api/analyst/query' -Method POST -Body $queryBody -ContentType 'application/json'",
            "if ($fallbackResponse.answer) { Write-Host '✓ Fallback handling passed' }",
            "",
            "# Cleanup",
            "Stop-Process -Id $sqlServer.Id, $restServer.Id, $orchestrator.Id"
        ]
    },
    "integrationPatterns": {
        "parallel": {
            "description": "Query independent MCP servers concurrently",
            "use": "When data sources are unrelated (e.g., customers from SQL + inventory from REST)"
        },
        "sequential": {
            "description": "Chain MCP calls where output of one feeds input of next",
            "use": "When second query depends on first result (e.g., get customerId → get customer orders)"
        },
        "fanOut": {
            "description": "Send same query to multiple servers and merge results",
            "use": "When data is partitioned across servers (e.g., regional databases)"
        },
        "caching": {
            "description": "Cache MCP responses with TTL",
            "use": "For frequently accessed, slowly changing data (e.g., product catalog)"
        }
    },
    "groupDeliverables": [
        "Working orchestrator service (HTTP API)",
        "At least 2 functioning MCP servers (can reuse from exercises 1-3)",
        "Demonstration of answering 3 business questions",
        "Architecture diagram (Mermaid)",
        "README with setup instructions"
    ],
    "evaluationRubric": {
        "functionality": {
            "weight": 40,
            "criteria": [
                "Orchestrator connects to multiple MCP servers",
                "Queries execute successfully",
                "Responses are synthesized coherently"
            ]
        },
        "architecture": {
            "weight": 30,
            "criteria": [
                "Clean separation of concerns",
                "Appropriate use of integration patterns",
                "Error handling implemented"
            ]
        },
        "performance": {
            "weight": 20,
            "criteria": [
                "Multi-source queries complete < 2s",
                "Caching reduces redundant calls"
            ]
        },
        "documentation": {
            "weight": 10,
            "criteria": [
                "Clear architecture diagram",
                "Setup instructions work"
            ]
        }
    }
}